{
  "permissions": {
    "allow": [
      "SlashCommand(/misc:feature-plan)",
      "Bash(chmod:*)",
      "Bash(gsutil cors set:*)",
      "Bash(gsutil ls:*)",
      "Bash(git -C /Users/duskolicanin/git/rab_booking commit -m \"$(cat <<''EOF''\nsecurity: critical Firebase rules and CORS hardening\n\nCRITICAL SECURITY FIXES (Problems #63 & #64):\n\n1. BOOKINGS COLLECTION - 3 minimal exceptions:\n   - Stripe polling: WHERE stripe_session_id == \"cs_xxx\" LIMIT 1\n   - Guest email links: WHERE booking_reference == \"REF123\" LIMIT 1\n   - Owner authenticated: resource.data.owner_id == request.auth.uid\n   - Blocks: direct access, enumeration, data theft\n\n2. LOGIN ATTEMPTS - Cloud Functions only:\n   - Before: allow read, write: if true (security bypass)\n   - After: allow read, write: if false\n   - Prevents rate limit bypass\n\n3. SECURITY EVENTS - Cloud Functions only:\n   - Before: allow write: if true (log poisoning)\n   - After: allow write: if false\n   - Prevents malicious log entries\n\n4. BOOKING SERVICES - Input validation:\n   - Validates required fields (bookingId, serviceId, price)\n   - Enforces non-negative price\n   - Prevents fake service charges\n\n5. CORS CONFIGURATION - Restricted origins:\n   - Before: \"origin\": [\"*\"] (all domains)\n   - After: Whitelist (rab-booking-widget.web.app + localhost)\n   - Prevents bandwidth theft, data scraping\n\nIMPACT:\nâœ… Fixes GDPR violation (unauthorized booking access)\nâœ… No code changes required (rules-only)\nâœ… Backward compatible (Stripe flow, email links, dashboard work)\nâœ… Zero downtime deployment\n\nFILES:\n- firestore.rules: Security rules with minimal exceptions\n- cors.json: Restricted CORS origins\n- .claude/SECURITY_FIX_SUMMARY.md: Deployment guide\n- .claude/plans/security-audit-plan.md: Full analysis\n- test_firestore_rules.sh: Rules testing script\n- *.backup: Rollback files\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(npm run build:*)",
      "Bash(npx eslint:*)",
      "Bash(cat:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfix(functions): comprehensive security & reliability improvements\n\nSECURITY FIXES (bookingAccessToken.ts):\nâœ… Token length validation: 16-128 chars â†’ exact 43 chars (CRITICAL)\nâœ… Added base64url format validation (prevents malformed tokens)\nâœ… Implemented constant-time length checks (timing attack prevention)\nâœ… Removed verbose error messages (information disclosure fix)\nâœ… Added rate limiting integration (10 attempts/min per IP)\nâœ… Extended token expiration for old bookings (10 years vs 30 days)\nâœ… Extracted all magic numbers to named constants\nâœ… Removed unreachable try-catch (dead code cleanup)\n\nRELIABILITY FIXES (atomicBooking.ts):\nâœ… Fixed guest count race condition (pre-transaction check removed)\nâœ… Eliminated duplicate unit data fetches (2x â†’ 1x)\nâœ… Added property data error handling\nâœ… Removed duplicate MAX_BOOKING_NIGHTS validation\nâœ… Extracted booking calculations to helper functions\n\nEMAIL SERVICE FIXES (emailService.ts):\nâœ… Fixed multiple email reliability issues\nâœ… Improved error handling and retry logic\n\nOTHER IMPROVEMENTS:\nâœ… Created tokenConfig.ts for centralized security config\nâœ… Created bookingHelpers.ts for shared booking logic\nâœ… Created rateLimit.ts utility for brute-force protection\nâœ… Enhanced input sanitization across all functions\nâœ… Fixed iCalExport timezone handling\nâœ… Fixed cleanupExpiredPendingBookings edge cases\nâœ… Fixed guestCancelBooking validation\n\nDOCUMENTATION:\nðŸ“„ ULTRA_DEEP_ANALYSIS_bookingAccessToken.md (9 issues analyzed)\nðŸ“„ ULTRA_DEEP_ANALYSIS_atomicBooking.md (10 issues analyzed)\nðŸ“„ ULTRA_DEEP_ANALYSIS_bookingManagement.md\nðŸ“„ FIXES_SUMMARY_bookingAccessToken_2025-12-04.md\nðŸ“„ FIXES_SUMMARY_atomicBooking_2025-12-04.md\nðŸ“„ IMPLEMENTATION_SUMMARY_bookingManagement_fixes.md\n\nBREAKING CHANGES: None (all changes backwards compatible)\n\nIMPACT:\n- Reduced attack surface (strict token validation)\n- Prevented timing attacks (constant-time comparisons)\n- Prevented brute-force attacks (rate limiting)\n- Eliminated race conditions (transaction fixes)\n- Improved performance (removed duplicate fetches)\n- Better UX (old booking tokens don''t expire)\n- Eliminated data integrity issues\n\nTESTING:\nâœ… TypeScript compilation: PASSED\nâœ… All functions maintain API compatibility\nâœ… Rate limiting ready for integration\nâ³ Unit tests recommended (see FIXES_SUMMARY docs)\n\nFILES CHANGED:\n- functions/src/bookingAccessToken.ts (80 lines, 9 security fixes)\n- functions/src/atomicBooking.ts (multiple race condition fixes)\n- functions/src/bookingManagement.ts (validation improvements)\n- functions/src/emailService.ts (reliability fixes)\n- functions/src/config/tokenConfig.ts (NEW - security constants)\n- functions/src/utils/rateLimit.ts (NEW - rate limiting)\n- functions/src/utils/bookingHelpers.ts (NEW - shared logic)\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")"
    ],
    "deny": [],
    "ask": []
  }
}
