name: Build & Deploy

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  # Run tests first
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info

  # Build Android APK
  build-android:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build APK (Development)
        if: github.event.inputs.environment == 'development' || github.ref == 'refs/heads/develop'
        run: flutter build apk --release --flavor development

      - name: Build APK (Staging)
        if: github.event.inputs.environment == 'staging'
        run: flutter build apk --release --flavor staging

      - name: Build APK (Production)
        if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/v')
        run: flutter build apk --release --flavor production --split-per-abi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/*.apk

  # Build iOS IPA
  build-ios:
    needs: test
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build iOS (Development)
        if: github.event.inputs.environment == 'development' || github.ref == 'refs/heads/develop'
        run: flutter build ios --release --no-codesign --flavor development

      - name: Build iOS (Staging)
        if: github.event.inputs.environment == 'staging'
        run: flutter build ios --release --no-codesign --flavor staging

      - name: Build iOS (Production)
        if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/v')
        run: flutter build ios --release --no-codesign --flavor production

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v3
        with:
          name: ios-build
          path: build/ios/iphoneos/*.app

  # Build Web
  build-web:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Web (Development)
        if: github.event.inputs.environment == 'development' || github.ref == 'refs/heads/develop'
        run: flutter build web --release --dart-define=ENV=development

      - name: Build Web (Staging)
        if: github.event.inputs.environment == 'staging'
        run: flutter build web --release --dart-define=ENV=staging

      - name: Build Web (Production)
        if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/v')
        run: flutter build web --release --dart-define=ENV=production

      - name: Upload Web artifact
        uses: actions/upload-artifact@v3
        with:
          name: web-build
          path: build/web

  # Deploy Web to Firebase Hosting (optional)
  deploy-web:
    needs: build-web
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download Web artifact
        uses: actions/download-artifact@v3
        with:
          name: web-build
          path: build/web

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: rab-booking

  # Create GitHub Release
  create-release:
    needs: [build-android, build-ios, build-web]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android-apk/*.apk
            ios-build/*.app
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
