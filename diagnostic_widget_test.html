<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Diagnostic Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .widget-container {
            width: 100%;
            height: 900px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin-bottom: 15px;
        }

        .warning {
            background: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
        }

        .error {
            background: #f8d7da;
            padding: 15px;
            border-left: 4px solid #dc3545;
            margin-bottom: 15px;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #1976D2;
        }

        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .checklist li:before {
            content: "‚¨ú ";
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Widget Diagnostic Test - Localhost</h1>

        <div class="test-section">
            <h2>üìã Testing Checklist</h2>
            <div class="info">
                <strong>Follow these steps to test the widget:</strong>
            </div>
            <ul class="checklist">
                <li>Widget loads without errors (check DevTools Console - F12)</li>
                <li>Calendar is visible and displays dates</li>
                <li>Select check-in date (click on a future date)</li>
                <li>Select check-out date (click on another date after check-in)</li>
                <li><strong>Floating pill bar appears at bottom</strong> after date selection</li>
                <li>Price calculation is visible in the pill</li>
                <li>Click "Continue" button on pill to open guest form</li>
                <li>Guest form slides up from bottom</li>
                <li>Additional services section visible in form (if configured)</li>
                <li>Payment methods visible (Stripe/Bank Transfer)</li>
                <li>Tax/Legal disclaimer visible at bottom of form</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üéØ Test URLs</h2>
            <button onclick="loadWidget('production')">Load Production (Firebase)</button>
            <button onclick="loadWidget('localhost')">Load Localhost</button>
            <button onclick="loadWidget('localhost-test')">Load Test Unit (localhost)</button>
            <button onclick="clearConsole()">Clear Console</button>
        </div>

        <div class="test-section">
            <h2>‚ö†Ô∏è Common Issues</h2>
            <div class="warning">
                <strong>If floating pill doesn't appear:</strong><br>
                1. Make sure you selected BOTH check-in and check-out dates<br>
                2. Check browser console for errors (F12 ‚Üí Console)<br>
                3. Verify widget_mode is not "calendar_only" in Firestore<br>
                4. Check if price calculation provider has errors
            </div>

            <div class="warning">
                <strong>If additional services don't appear:</strong><br>
                1. Unit must have services configured in Firestore (units/{unitId}/additional_services)<br>
                2. Services must be enabled in widget settings
            </div>

            <div class="warning">
                <strong>If no title/logo appears:</strong><br>
                1. Logo is configured in widget_settings ‚Üí theme_options ‚Üí custom_logo_url<br>
                2. Title should come from property/unit name in Firestore
            </div>
        </div>

        <div class="test-section">
            <h2>üì± Widget Preview</h2>
            <div id="current-url" style="margin-bottom: 10px; font-size: 14px; color: #666;"></div>
            <div class="widget-container">
                <iframe id="widget-frame" src=""></iframe>
            </div>
        </div>

        <div class="test-section">
            <h2>üîß Debug Information</h2>
            <button onclick="checkFirestore()">Check Firestore Settings</button>
            <button onclick="testPriceCalc()">Test Price Calculation</button>
            <div id="debug-output"></div>
        </div>
    </div>

    <script>
        const PRODUCTION_URL = 'https://rab-booking-widget.web.app/?unit=gMIOos56siO74VkCsSwY&property=fg5nlt3aLlx4HWJeqliq';
        const LOCALHOST_URL = 'http://localhost:8080/?unit=gMIOos56siO74VkCsSwY&property=fg5nlt3aLlx4HWJeqliq';
        const LOCALHOST_TEST_URL = 'http://localhost:8080/?unit=test-unit-123&property=test-property-123';

        function loadWidget(type) {
            const iframe = document.getElementById('widget-frame');
            const urlDisplay = document.getElementById('current-url');

            let url;
            switch(type) {
                case 'production':
                    url = PRODUCTION_URL;
                    break;
                case 'localhost':
                    url = LOCALHOST_URL;
                    break;
                case 'localhost-test':
                    url = LOCALHOST_TEST_URL;
                    break;
            }

            iframe.src = url;
            urlDisplay.textContent = `Loading: ${url}`;

            console.log(`%c[Widget Test] Loading ${type}`, 'color: #2196F3; font-weight: bold');
            console.log(`URL: ${url}`);
        }

        function clearConsole() {
            console.clear();
            console.log('%c[Widget Test] Console cleared', 'color: #4CAF50; font-weight: bold');
        }

        function checkFirestore() {
            const output = document.getElementById('debug-output');
            output.innerHTML = `
                <div class="info" style="margin-top: 15px;">
                    <strong>To check Firestore settings manually:</strong><br><br>
                    1. Open Firebase Console: https://console.firebase.google.com<br>
                    2. Navigate to Firestore Database<br>
                    3. Check path: <code>properties/fg5nlt3aLlx4HWJeqliq/widget_settings/gMIOos56siO74VkCsSwY</code><br><br>

                    <strong>Expected fields:</strong><br>
                    ‚Ä¢ widget_mode: "booking_instant" (not "calendar_only")<br>
                    ‚Ä¢ stripe_config.enabled: true<br>
                    ‚Ä¢ bank_transfer_config.enabled: true<br>
                    ‚Ä¢ theme_options.custom_logo_url: "https://..."<br>
                    ‚Ä¢ blur_config.enabled: true<br>
                    ‚Ä¢ tax_legal_config.enabled: true<br><br>

                    <strong>Check also:</strong><br>
                    ‚Ä¢ properties/{propertyId}/units/{unitId}/additional_services - for extra services<br>
                    ‚Ä¢ properties/{propertyId}/units/{unitId} - for unit name and details
                </div>
            `;
        }

        function testPriceCalc() {
            const output = document.getElementById('debug-output');
            output.innerHTML = `
                <div class="warning" style="margin-top: 15px;">
                    <strong>To test price calculation:</strong><br><br>
                    1. Open browser DevTools (F12)<br>
                    2. Go to Console tab<br>
                    3. Select dates on calendar<br>
                    4. Watch for console output<br>
                    5. Look for errors related to "bookingPriceProvider" or "price calculation"<br><br>

                    <strong>Common price calc errors:</strong><br>
                    ‚Ä¢ Missing price data in Firestore (check price_list collection)<br>
                    ‚Ä¢ Invalid date range (dates in past)<br>
                    ‚Ä¢ Unit not found<br>
                    ‚Ä¢ Price calculation formula error
                </div>
            `;
        }

        // Auto-load localhost on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadWidget('localhost');

            console.log('%c========================================', 'color: #2196F3');
            console.log('%cüîç Widget Diagnostic Test', 'color: #2196F3; font-size: 20px; font-weight: bold');
            console.log('%c========================================', 'color: #2196F3');
            console.log('');
            console.log('%cInstructions:', 'font-weight: bold');
            console.log('1. Select check-in date on calendar');
            console.log('2. Select check-out date on calendar');
            console.log('3. Floating pill bar should appear at bottom');
            console.log('4. Click "Continue" to open guest form');
            console.log('');
            console.log('%cWatch this console for errors!', 'color: #f44336; font-weight: bold');
            console.log('');
        });

        // Listen for console messages from iframe
        window.addEventListener('message', function(event) {
            console.log('%c[Widget Message]', 'color: #9C27B0; font-weight: bold', event.data);
        });
    </script>
</body>
</html>
