rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the resource by owner_id field
    // STRICT: No legacy support - all documents must have valid owner_id
    function isResourceOwner() {
      return isAuthenticated() && resource.data.owner_id == request.auth.uid;
    }

    // Check if user is creating resource as themselves
    // CRITICAL SECURITY: Ensures owner_id in new document matches authenticated user
    function canCreateAsOwner() {
      return isAuthenticated() && request.resource.data.owner_id == request.auth.uid;
    }

    // Check if user owns the document by userId param (for user subcollections)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user owns the parent property
    // STRICT: No legacy support - property must have valid owner_id
    function isPropertyOwner(propertyId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/properties/$(propertyId)).data.owner_id == request.auth.uid;
    }

    // ========================================================================
    // USERS COLLECTION
    // ========================================================================
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);

      // User data subcollection (profile, company, preferences)
      match /data/{document} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }

      // Security events subcollection
      match /securityEvents/{eventId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }

      // Notifications subcollection
      // Path: users/{userId}/notifications/{notificationId}
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        // Only Cloud Functions can create notifications (via Admin SDK)
        allow create: if false;
        // User can only update isRead field
        allow update: if isOwner(userId) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
        allow delete: if isOwner(userId);
      }

      // Rate limits - only Cloud Functions
      match /rate_limits/{action} {
        allow read: if false;
        allow write: if false;
      }
    }

    // User Profiles - LEGACY collection (kept for backwards compatibility)
    match /user_profiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // ========================================================================
    // PROPERTIES COLLECTION (MAIN STRUCTURE)
    // ========================================================================
    match /properties/{propertyId} {
      // PUBLIC READ: Properties are public data for widget booking functionality
      // Contains: name, description, location, amenities, images
      // NOTE: owner_id is visible but not sensitive (similar to Airbnb host profiles)
      allow read: if true;
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();

      // Units subcollection
      match /units/{unitId} {
        allow read: if true; // Public read for widget
        allow create, update, delete: if isPropertyOwner(propertyId);

        // Bookings subcollection
        // SECURITY FIX: Same rules as collection group (see below for full documentation)
        // - Owner: Read their own bookings (by owner_id)
        // - Widget: Read availability (by unit_id + status)
        // - Stripe: Poll payment (by stripe_session_id)
        // - Guest: View booking (by booking_reference)
        match /bookings/{bookingId} {
          // üõ°Ô∏è SENTINEL: Consistent security - rule matches collection group
          allow read: if isResourceOwner();
          allow create, update, delete: if isPropertyOwner(propertyId);
        }

        // Daily prices subcollection
        match /daily_prices/{dateStr} {
          allow read: if true; // Public read for widget price display
          allow create, update, delete: if isPropertyOwner(propertyId);
        }
      }

      // Widget settings subcollection
      match /widget_settings/{unitId} {
        allow read: if true; // Widget needs to read settings
        allow create, update, delete: if isPropertyOwner(propertyId);
      }

      // iCal events subcollection
      match /ical_events/{eventId} {
        allow read: if true; // Widget needs to read events for availability
        allow create, update, delete: if isPropertyOwner(propertyId);
      }
    }

    // ========================================================================
    // COLLECTION GROUP QUERIES
    // Enables cross-property/cross-unit queries for dashboard and widget
    // ========================================================================

    // Collection group: units
    match /{path=**}/units/{unitId} {
      allow read: if true;
      // Writes via property_id lookup
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // Collection group: widget_settings
    match /{path=**}/widget_settings/{unitId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // Collection group: bookings
    // Used by: Owner dashboard, Guest bookings, Widget calendar, Stripe polling
    //
    // SECURITY: Multi-layered access control
    // Primary defense: owner_id check ensures users can only read their own bookings
    // Secondary: Specific query patterns for public/guest access (widget, stripe, booking view)
    //
    // ALLOWED ACCESS:
    // 1. Owner: Read their own bookings (by owner_id == auth.uid)
    //    - Works with ANY query pattern (unit_id filters, date ranges, etc.)
    //    - Realtime subscriptions, analytics, dashboard - all allowed
    // 2. Widget: Read availability ONLY (by unit_id + status) - public calendar
    // 3. Stripe: Poll payment status (by stripe_session_id)
    // 4. Guest: View own booking (by booking_reference)
    //
    // SECURITY NOTE: The owner_id check is the PRIMARY security boundary.
    // Even if attacker knows competitor's unit_ids and queries by them,
    // the rule will only return documents where owner_id == attacker's uid (none).
    match /{path=**}/bookings/{bookingId} {
      // üõ°Ô∏è SENTINEL: CRITICAL PII LEAK FIXED
      // The previous rules allowed any unauthenticated user to read entire booking documents,
      // including guest PII (name, email, phone), by guessing a unit_id, stripe_session_id,
      // or booking_reference. This relied on insecure client-side filtering.
      // The rule is now locked down to STRICT owner-only access.
      //
      // TODO: Re-enable safe public access (e.g., for calendars) via a secure
      // Cloud Function proxy that only exposes non-sensitive data.
      allow read: if isResourceOwner();
      // Writes go through specific subcollection path above
    }

    // Collection group: daily_prices
    // Used by: Price calculator, Availability checker
    match /{path=**}/daily_prices/{priceId} {
      allow read: if true;
      // Writes go through specific subcollection path above
    }

    // Collection group: ical_events
    // Used by: Availability checker (widget needs to check external calendar blocks)
    match /{path=**}/ical_events/{eventId} {
      allow read: if true;
      // Writes go through specific subcollection path above
    }

    // ========================================================================
    // DEPRECATED TOP-LEVEL COLLECTIONS
    // Kept for backward compatibility - migrate data to subcollections
    // TODO: Remove after confirming no legacy data remains
    // ========================================================================

    // DEPRECATED: Top-level units
    match /units/{unitId} {
      allow read: if true;
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // DEPRECATED: Top-level bookings
    // Same security rules as subcollection for consistency
    match /bookings/{bookingId} {
      // üõ°Ô∏è SENTINEL: Consistent security - rule matches collection group
      allow read: if isResourceOwner();
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // DEPRECATED: Top-level daily_prices
    match /daily_prices/{priceId} {
      allow read: if true;
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // DEPRECATED: Top-level ical_events
    match /ical_events/{eventId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // ========================================================================
    // OTHER COLLECTIONS
    // ========================================================================

    // Additional services - owners manage, anyone can read
    match /additional_services/{serviceId} {
      allow read: if true; // Widget needs to read services
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // Platform connections - external platform OAuth/API connections (Booking.com, Airbnb)
    // Owner can read/write their own connections
    match /platform_connections/{connectionId} {
      allow read: if isResourceOwner();
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // iCal feeds - owner dashboard manages external calendar imports
    match /ical_feeds/{feedId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // Booking services - junction table for booking ‚Üî additional_services
    // Only Cloud Functions create these (during booking creation)
    match /booking_services/{bookingServiceId} {
      allow read: if true; // Widget needs to read for price calculation
      allow create: if false; // Only Cloud Functions via Admin SDK
      allow update, delete: if isResourceOwner();
    }

    // ========================================================================
    // LOCKED COLLECTIONS - Only Cloud Functions via Admin SDK
    // ========================================================================

    // Login attempts - rate limiting
    match /loginAttempts/{email} {
      allow read: if false;
      allow write: if false;
    }

    // Email verifications - OTP codes
    match /email_verifications/{emailHash} {
      allow read: if false;
      allow write: if false;
    }

    // Security events - audit log (top-level, deprecated)
    match /securityEvents/{eventId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false;
    }

    // Security events - new collection for security monitoring
    // Only Cloud Functions can write via Admin SDK
    match /security_events/{eventId} {
      allow read: if false; // Only accessible via Firebase Console
      allow write: if false; // Only Cloud Functions via Admin SDK
    }

    // Email templates - locked for future use
    match /email_templates/{templateId} {
      allow read: if false;
      allow write: if false;
    }

    // Tenants - locked for future use
    match /tenants/{tenantId} {
      allow read: if false;
      allow write: if false;
    }
  }
}
