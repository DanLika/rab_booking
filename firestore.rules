rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the resource by owner_id field
    // STRICT: No legacy support - all documents must have valid owner_id
    function isResourceOwner() {
      return isAuthenticated() && resource.data.owner_id == request.auth.uid;
    }

    // Check if user is creating resource as themselves
    // CRITICAL SECURITY: Ensures owner_id in new document matches authenticated user
    function canCreateAsOwner() {
      return isAuthenticated() && request.resource.data.owner_id == request.auth.uid;
    }

    // Check if user owns the document by userId param (for user subcollections)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user owns the parent property
    // STRICT: No legacy support - property must have valid owner_id
    function isPropertyOwner(propertyId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/properties/$(propertyId)).data.owner_id == request.auth.uid;
    }

    // ========================================================================
    // USERS COLLECTION
    // ========================================================================
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);

      // User data subcollection (profile, company, preferences)
      match /data/{document} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }

      // Security events subcollection
      match /securityEvents/{eventId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }

      // Notifications subcollection
      // Path: users/{userId}/notifications/{notificationId}
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        // Only Cloud Functions can create notifications (via Admin SDK)
        allow create: if false;
        // User can only update isRead field
        allow update: if isOwner(userId) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
        allow delete: if isOwner(userId);
      }

      // Rate limits - only Cloud Functions
      match /rate_limits/{action} {
        allow read: if false;
        allow write: if false;
      }
    }

    // User Profiles - LEGACY collection (kept for backwards compatibility)
    match /user_profiles/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // ========================================================================
    // PROPERTIES COLLECTION (MAIN STRUCTURE)
    // ========================================================================
    match /properties/{propertyId} {
      allow read: if true; // Public read for widget
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();

      // Units subcollection
      match /units/{unitId} {
        allow read: if true; // Public read for widget
        allow create, update, delete: if isPropertyOwner(propertyId);

        // Bookings subcollection
        // READ: Selective access (see collection group rule for details)
        // - Owner: by owner_id
        // - Widget calendar: by unit_id + status
        // - Stripe polling: by stripe_session_id
        // - Booking view: by booking_reference
        match /bookings/{bookingId} {
          allow read: if
            // Owner can read their own bookings
            (isAuthenticated() && resource.data.owner_id == request.auth.uid) ||
            // Widget calendar and other valid queries (fields must exist)
            ('unit_id' in resource.data && 'status' in resource.data) ||
            ('stripe_session_id' in resource.data && resource.data.stripe_session_id != null) ||
            ('booking_reference' in resource.data && resource.data.booking_reference != null);
          allow create, update, delete: if isPropertyOwner(propertyId);
        }

        // Daily prices subcollection
        match /daily_prices/{dateStr} {
          allow read: if true; // Public read for widget price display
          allow create, update, delete: if isPropertyOwner(propertyId);
        }
      }

      // Widget settings subcollection
      match /widget_settings/{unitId} {
        allow read: if true; // Widget needs to read settings
        allow create, update, delete: if isPropertyOwner(propertyId);
      }

      // iCal events subcollection
      match /ical_events/{eventId} {
        allow read: if true; // Widget needs to read events for availability
        allow create, update, delete: if isPropertyOwner(propertyId);
      }
    }

    // ========================================================================
    // COLLECTION GROUP QUERIES
    // Enables cross-property/cross-unit queries for dashboard and widget
    // ========================================================================

    // Collection group: units
    match /{path=**}/units/{unitId} {
      allow read: if true;
      // Writes via property_id lookup
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // Collection group: widget_settings
    match /{path=**}/widget_settings/{unitId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // Collection group: bookings
    // Used by: Owner dashboard, Guest bookings, Widget calendar, Stripe polling
    //
    // SECURITY: Selective read access based on query type:
    // 1. Owner can read all their bookings (by owner_id in document)
    // 2. Owner analytics: queries by unit_id + check_in (for revenue/stats)
    // 3. Widget calendar: queries by unit_id + status (for availability display)
    // 4. Stripe polling: queries by stripe_session_id (after payment redirect)
    // 5. Booking view: queries by booking_reference (for guest access)
    //
    // NOTE: Firestore doesn't support field-level security, so all document
    // fields are readable when query is allowed. Widget only displays
    // availability data (dates, status), not guest PII.
    match /{path=**}/bookings/{bookingId} {
      allow read: if
        // Case 1: Authenticated owner can read their own bookings
        (isAuthenticated() && resource.data.owner_id == request.auth.uid) ||
        // Case 2: Owner analytics queries (by unit_id + check_in for date range)
        // Authenticated users can query bookings by unit_id and check_in date
        // Requires collection group index: unit_id ASC, check_in ASC
        (isAuthenticated() && 'unit_id' in resource.data && 'check_in' in resource.data) ||
        // Case 3: Widget calendar availability queries (unit_id + status)
        // Requires collection group index: unit_id ASC, status ASC
        ('unit_id' in resource.data && 'status' in resource.data) ||
        // Case 4: Stripe polling after payment (by stripe_session_id)
        // Requires collection group index: stripe_session_id ASC
        ('stripe_session_id' in resource.data && resource.data.stripe_session_id != null) ||
        // Case 5: Guest booking view (by booking_reference)
        // Requires collection group index: booking_reference ASC
        ('booking_reference' in resource.data && resource.data.booking_reference != null);
      // Writes go through specific subcollection path above
    }

    // Collection group: daily_prices
    // Used by: Price calculator, Availability checker
    match /{path=**}/daily_prices/{priceId} {
      allow read: if true;
      // Writes go through specific subcollection path above
    }

    // Collection group: ical_events
    // Used by: Availability checker (widget needs to check external calendar blocks)
    match /{path=**}/ical_events/{eventId} {
      allow read: if true;
      // Writes go through specific subcollection path above
    }

    // ========================================================================
    // DEPRECATED TOP-LEVEL COLLECTIONS
    // Kept for backward compatibility - migrate data to subcollections
    // TODO: Remove after confirming no legacy data remains
    // ========================================================================

    // DEPRECATED: Top-level units
    match /units/{unitId} {
      allow read: if true;
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // DEPRECATED: Top-level bookings
    // Same security rules as subcollection for consistency
    match /bookings/{bookingId} {
      allow read: if
        (isAuthenticated() && resource.data.owner_id == request.auth.uid) ||
        ('unit_id' in resource.data && 'status' in resource.data) ||
        ('stripe_session_id' in resource.data && resource.data.stripe_session_id != null) ||
        ('booking_reference' in resource.data && resource.data.booking_reference != null);
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // DEPRECATED: Top-level daily_prices
    match /daily_prices/{priceId} {
      allow read: if true;
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // DEPRECATED: Top-level ical_events
    match /ical_events/{eventId} {
      allow read: if true;
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // ========================================================================
    // OTHER COLLECTIONS
    // ========================================================================

    // Additional services - owners manage, anyone can read
    match /additional_services/{serviceId} {
      allow read: if true; // Widget needs to read services
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // Platform connections - external platform OAuth/API connections (Booking.com, Airbnb)
    // Owner can read/write their own connections
    match /platform_connections/{connectionId} {
      allow read: if isResourceOwner();
      allow create: if canCreateAsOwner();
      allow update, delete: if isResourceOwner();
    }

    // iCal feeds - owner dashboard manages external calendar imports
    match /ical_feeds/{feedId} {
      allow read: if isAuthenticated() && (
        resource == null ||
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        ('property_id' in request.resource.data) &&
        get(/databases/$(database)/documents/properties/$(request.resource.data.property_id)).data.owner_id == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        ('property_id' in resource.data) &&
        get(/databases/$(database)/documents/properties/$(resource.data.property_id)).data.owner_id == request.auth.uid;
    }

    // Booking services - junction table for booking â†” additional_services
    // Only Cloud Functions create these (during booking creation)
    match /booking_services/{bookingServiceId} {
      allow read: if true; // Widget needs to read for price calculation
      allow create: if false; // Only Cloud Functions via Admin SDK
      allow update, delete: if isResourceOwner();
    }

    // ========================================================================
    // LOCKED COLLECTIONS - Only Cloud Functions via Admin SDK
    // ========================================================================

    // Login attempts - rate limiting
    match /loginAttempts/{email} {
      allow read: if false;
      allow write: if false;
    }

    // Email verifications - OTP codes
    match /email_verifications/{emailHash} {
      allow read: if false;
      allow write: if false;
    }

    // Security events - audit log (top-level, deprecated)
    match /securityEvents/{eventId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if false;
    }

    // Security events - new collection for security monitoring
    // Only Cloud Functions can write via Admin SDK
    match /security_events/{eventId} {
      allow read: if false; // Only accessible via Firebase Console
      allow write: if false; // Only Cloud Functions via Admin SDK
    }

    // Email templates - locked for future use
    match /email_templates/{templateId} {
      allow read: if false;
      allow write: if false;
    }

    // Tenants - locked for future use
    match /tenants/{tenantId} {
      allow read: if false;
      allow write: if false;
    }
  }
}
