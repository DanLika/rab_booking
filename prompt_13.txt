PROMPT 13: Payment Integration - Stripe

Implementiraj Stripe payment flow:

1. SETUP:

   a) Backend Function (Supabase Edge Function):
   ```typescript
   // supabase/functions/create-payment-intent/index.ts
   // Kreiranje payment intent sa izračunatim iznosom (20% avansa)

   import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
   import Stripe from 'https://esm.sh/stripe@11.1.0?target=deno'

   const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY') || '', {
     apiVersion: '2022-11-15',
   })

   serve(async (req) => {
     const { bookingId, totalAmount } = await req.json()

     // Calculate 20% advance
     const advanceAmount = Math.round(totalAmount * 0.20)

     const paymentIntent = await stripe.paymentIntents.create({
       amount: advanceAmount, // in cents
       currency: 'eur',
       metadata: { bookingId },
     })

     return new Response(
       JSON.stringify({ clientSecret: paymentIntent.client_secret }),
       { headers: { "Content-Type": "application/json" } }
     )
   })
   ```

   b) Flutter Configuration:
      - Dodaj Stripe publishable key u .env
      - Inicijalizuj Stripe u main.dart

2. PAYMENT FLOW:

   a) `lib/features/payment/presentation/screens/payment_screen.dart`:

      UI:
      - Booking summary (dates, unit, guests)
      - Price breakdown:
        * Total price
        * Advance (20%)
        * Amount to pay now
      - Payment form (Stripe Elements)
      - "Pay Now" button

   b) Payment Process:
      1. User taps "Book Now" → Navigate to PaymentScreen
      2. Create Booking record sa status: 'pending_payment'
      3. Call Supabase function → Get PaymentIntent
      4. Show Stripe payment sheet
      5. User enters card details
      6. On success: Update booking status → 'confirmed'
      7. Navigate to ConfirmationScreen

3. BOOKING FLOW SCREENS:

   `lib/features/booking/presentation/screens/`:

   a) `booking_review_screen.dart`:
      - Booking summary
      - Guest details form
      - Price breakdown:
        * Nights × price per night
        * Service fee (10%)
        * Total
        * Advance to pay (20%)
      - "Proceed to Payment" button

   b) `payment_screen.dart`:
      - Stripe CardField widget
      - "Pay Now" button
      - Payment processing indicator
      - Error handling

   c) `payment_success_screen.dart`:
      - Success icon/animation
      - Booking confirmation details
      - "View Booking" button
      - Email confirmation sent message

4. `lib/features/payment/services/payment_service.dart`:

   Methods:
   - createPaymentIntent(bookingId, amount)
   - confirmPayment(paymentIntentId)
   - handlePaymentSuccess(bookingId)
   - handlePaymentError(error)

   PAYMENT FLOW LOGIC (Original):

   Methods:
   - createPaymentIntent(bookingId, amount)
   - confirmPayment(clientSecret, cardDetails)
   - handlePaymentResult(result)

5. CONFIRMATION SCREEN:
   - Success animation (Lottie)
   - Booking details
   - "View Booking" button
   - "Download Receipt" button

6. ERROR HANDLING:
   - Payment declined
   - Network errors
   - Timeout handling
   - Retry logic

Implementiraj sa proper error messages i loading states.

7. STATE MANAGEMENT:

   - BookingFlowNotifier:
     * Current step (review → payment → success)
     * Selected dates, unit, guests
     * Total price calculation

   - PaymentNotifier:
     * Payment intent state
     * Processing status
     * Error handling

8. SUPABASE INTEGRATION:

   After successful payment:
   - Update booking status to 'confirmed'
   - Insert payment record:
     ```sql
     INSERT INTO payments (booking_id, amount, status, stripe_payment_id)
     VALUES (?, ?, 'completed', ?)
     ```
   - Send confirmation email (Supabase Function)

9. ERROR HANDLING (Original):

   - Card declined
   - Network errors
   - Insufficient funds
   - User-friendly error messages
   - Retry mechanism

10. SECURITY:

   - Never expose Stripe Secret Key u klijent kodu
   - Sve payment operations kroz Supabase Edge Function
   - Validate booking availability prije payment
   - Prevent double booking sa transaction lock

DELIVERABLES:
- Supabase Edge Function za payment intent
- Booking review screen
- Payment screen sa Stripe CardField
- Payment success screen
- Payment service layer
- BookingFlowNotifier & PaymentNotifier
- Supabase integration (booking update, payment record)
- Error handling za sve payment scenarije
- Security best practices implementirane
