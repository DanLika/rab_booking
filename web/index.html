<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">

  <!-- CRITICAL: interactive-widget=resizes-content for Android Chrome keyboard -->
  <!-- This tells Chrome to resize Layout Viewport when keyboard opens/closes -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">

  <style>
    /* Prevent any scroll on html/body level */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* ========== NATIVE HTML SPLASH SCREEN ========== */
    /* Shows IMMEDIATELY while Flutter engine loads */
    #native-splash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #FAFAFA; /* Light mode default */
      z-index: 999999;
      transition: opacity 0.3s ease-out;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      #native-splash {
        background-color: #000000;
      }
      #native-splash .splash-logo-text {
        color: #FFFFFF;
      }
      #native-splash .splash-progress-bg {
        background-color: rgba(139, 92, 246, 0.2);
      }
      #native-splash .splash-progress-bar {
        background-color: #8B5CF6;
      }
      #native-splash .splash-percentage {
        color: rgba(255, 255, 255, 0.7);
      }
    }

    /* Logo container */
    .splash-logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 32px;
    }

    /* BookBed icon (SVG bed) */
    .splash-logo-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 8px;
    }

    /* BookBed text */
    .splash-logo-text {
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: #1A1A1A;
      letter-spacing: -0.5px;
    }

    /* Progress bar container */
    .splash-progress-container {
      width: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .splash-progress-bg {
      width: 100%;
      height: 4px;
      background-color: rgba(139, 92, 246, 0.2);
      border-radius: 2px;
      overflow: hidden;
    }

    .splash-progress-bar {
      height: 100%;
      width: 0%;
      background-color: #8B5CF6;
      border-radius: 2px;
      transition: width 0.1s ease-out;
    }

    .splash-percentage {
      margin-top: 12px;
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: rgba(26, 26, 26, 0.7);
    }

    /* Hidden state for fade-out */
    #native-splash.hidden {
      opacity: 0;
      pointer-events: none;
    }
  </style>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Discover your perfect vacation rental on the beautiful island of Rab, Croatia. Browse luxury properties, villas, and apartments with stunning Adriatic Sea views.">
  <meta name="keywords" content="Rab, Croatia, vacation rentals, holiday homes, apartments, villas, Adriatic Sea, booking">
  <meta name="author" content="RAB Booking">
  <meta name="robots" content="index, follow">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="RAB Booking - Luxury Vacation Rentals on Island Rab, Croatia">
  <meta property="og:description" content="Discover your perfect vacation rental on the beautiful island of Rab. Premium properties with stunning Adriatic Sea views.">
  <meta property="og:image" content="https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=1200">
  <meta property="og:url" content="https://bookbed.io">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="RAB Booking - Luxury Vacation Rentals">
  <meta name="twitter:description" content="Discover your perfect vacation rental on island Rab, Croatia">
  <meta name="twitter:image" content="https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=1200">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="RAB Booking">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Theme Color -->
  <meta name="theme-color" content="#0066FF">
  <meta name="msapplication-TileColor" content="#0066FF">

  <!-- Custom Styles -->
  <link rel="stylesheet" href="style.css">

  <title>RAB Booking - Luxury Vacation Rentals on Island Rab, Croatia</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <!-- ========== NATIVE HTML SPLASH SCREEN ========== -->
  <!-- Shows IMMEDIATELY while Flutter engine loads (before any JS executes) -->
  <div id="native-splash">
    <div class="splash-logo">
      <!-- BookBed Logo SVG - Villa Roof + Waves (matches AuthLogoIcon) -->
      <svg class="splash-logo-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Outer circle badge -->
        <circle cx="50" cy="50" r="40" stroke="#8B5CF6" stroke-width="3.5" fill="none"/>
        
        <!-- Villa roof triangle (top third) -->
        <path d="M 50 28 L 70 42 L 30 42 Z" fill="rgba(139, 92, 246, 0.2)" stroke="#8B5CF6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        
        <!-- Villa structure lines -->
        <line x1="40" y1="42" x2="40" y2="52" stroke="#8B5CF6" stroke-width="2.5" stroke-linecap="round"/>
        <line x1="60" y1="42" x2="60" y2="52" stroke="#8B5CF6" stroke-width="2.5" stroke-linecap="round"/>
        <line x1="30" y1="52" x2="70" y2="52" stroke="#8B5CF6" stroke-width="2.5" stroke-linecap="round"/>
        
        <!-- Wave 1 (bottom) -->
        <path d="M 25 75 Q 37 70 50 75 T 75 75" stroke="#8B5CF6" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        
        <!-- Wave 2 (middle) -->
        <path d="M 25 60 Q 37 55 50 60 T 75 60" stroke="#8B5CF6" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        
        <!-- Wave 3 (top) -->
        <path d="M 25 45 Q 37 40 50 45 T 75 45" stroke="#8B5CF6" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      </svg>
      <span class="splash-logo-text">BookBed</span>
    </div>
    <div class="splash-progress-container">
      <div class="splash-progress-bg">
        <div class="splash-progress-bar" id="splash-progress"></div>
      </div>
      <span class="splash-percentage" id="splash-percentage">0%</span>
    </div>
  </div>

  <!-- Native Splash Progress Animation -->
  <script>
    (function() {
      var progress = 0;
      var progressBar = document.getElementById('splash-progress');
      var percentageText = document.getElementById('splash-percentage');
      var targetProgress = 85; // Go to 85% quickly, then slow down
      
      // Animate progress bar
      var interval = setInterval(function() {
        if (progress < targetProgress) {
          // Fast progress to 85%
          var remaining = targetProgress - progress;
          progress += remaining * 0.08;
        } else if (progress < 95) {
          // Slow crawl from 85% to 95%
          progress += 0.1;
        }
        // Stop at 95%, Flutter will complete to 100%
        
        if (progressBar) {
          progressBar.style.width = progress + '%';
        }
        if (percentageText) {
          percentageText.textContent = Math.round(progress) + '%';
        }
      }, 50);
      
      // Store interval ID so Flutter can stop it
      window._nativeSplashInterval = interval;
      
      // Function for Flutter to call when ready
      window.hideNativeSplash = function(callback) {
        clearInterval(window._nativeSplashInterval);
        
        // Complete to 100%
        if (progressBar) progressBar.style.width = '100%';
        if (percentageText) percentageText.textContent = '100%';
        
        // Fade out after showing 100%
        setTimeout(function() {
          var splash = document.getElementById('native-splash');
          if (splash) {
            splash.classList.add('hidden');
            // Remove from DOM after transition
            setTimeout(function() {
              if (splash.parentNode) {
                splash.parentNode.removeChild(splash);
              }
              if (callback) callback();
            }, 300);
          } else if (callback) {
            callback();
          }
        }, 200);
      };
      
      // Safety: auto-hide after 15 seconds if Flutter fails to load
      setTimeout(function() {
        var splash = document.getElementById('native-splash');
        if (splash && !splash.classList.contains('hidden')) {
          console.warn('[SPLASH] Safety timeout - hiding after 15s');
          window.hideNativeSplash();
        }
      }, 15000);
    })();
  </script>

  <!-- PWA Install Prompt Handler -->
  <script>
    // Handle PWA install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67 and earlier from automatically showing the prompt
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      console.log('[PWA] Install prompt available');
      
      // You can show a custom install button here if needed
      // For now, we'll let the browser handle it automatically
    });

    // Track when app is installed
    window.addEventListener('appinstalled', (evt) => {
      console.log('[PWA] App installed successfully');
      deferredPrompt = null;
    });

    // Flutter automatically registers its service worker via flutter_bootstrap.js
    // No need for manual registration
  </script>

  <!-- AGGRESSIVE FIX for Flutter Issue #175074 - Android Chrome keyboard dismiss bug -->
  <!-- This workaround forces Flutter to recalculate physicalSize when keyboard closes -->
  <script>
    (function() {
      // Only run on Android
      var isAndroid = /Android/i.test(navigator.userAgent);
      if (!isAndroid) return;

      var viewport = window.visualViewport;
      if (!viewport) return;

      var fullHeight = viewport.height;
      var lastHeight = viewport.height;
      var wasKeyboardOpen = false;

      // Track the full screen height (when keyboard is closed)
      function updateFullHeight() {
        if (viewport.height > fullHeight) {
          fullHeight = viewport.height;
        }
      }

      // Force Flutter to recalculate by "jiggling" the container
      function forceFlutterRecalc() {
        var glassPane = document.querySelector('flt-glass-pane');
        if (!glassPane) return;

        // Get the shadow root where Flutter's canvas lives
        var shadowRoot = glassPane.shadowRoot;
        if (!shadowRoot) return;

        // Method 1: Temporarily change glass-pane dimensions
        var originalWidth = glassPane.style.width;
        var originalHeight = glassPane.style.height;

        // Jiggle: change size slightly, then restore
        glassPane.style.width = 'calc(100% - 1px)';
        glassPane.style.height = 'calc(100% - 1px)';

        // Force reflow
        void glassPane.offsetHeight;

        // Dispatch resize event
        window.dispatchEvent(new Event('resize'));

        // Restore after a frame
        requestAnimationFrame(function() {
          glassPane.style.width = originalWidth || '100%';
          glassPane.style.height = originalHeight || '100%';

          // Force another reflow and resize
          void glassPane.offsetHeight;
          window.dispatchEvent(new Event('resize'));

          // Schedule more resize events with delays
          [50, 100, 200, 300].forEach(function(delay) {
            setTimeout(function() {
              window.dispatchEvent(new Event('resize'));
              // Also scroll to top
              window.scrollTo(0, 0);
            }, delay);
          });
        });
      }

      // Listen to viewport resize
      viewport.addEventListener('resize', function() {
        var currentHeight = viewport.height;
        var heightDiff = currentHeight - lastHeight;

        updateFullHeight();

        // Detect keyboard dismiss: height increased significantly AND we're near full height
        var keyboardDismissed = heightDiff > 100 && currentHeight >= fullHeight - 50;

        // Also track if keyboard was previously open
        var keyboardWasOpen = lastHeight < fullHeight - 100;

        if (keyboardDismissed || (keyboardWasOpen && currentHeight >= fullHeight - 50)) {
          // Keyboard just closed - force Flutter to recalculate
          console.log('[KB-FIX] Keyboard dismissed, forcing Flutter recalc');

          // Blur active element first
          if (document.activeElement) {
            document.activeElement.blur();
          }

          // Force recalc with multiple attempts
          forceFlutterRecalc();

          // Additional attempts with delays
          setTimeout(forceFlutterRecalc, 100);
          setTimeout(forceFlutterRecalc, 250);
          setTimeout(forceFlutterRecalc, 500);

          wasKeyboardOpen = false;
        } else if (heightDiff < -100) {
          // Keyboard opened
          wasKeyboardOpen = true;
        }

        lastHeight = currentHeight;
      });

      // Also listen to focusout as backup
      window.addEventListener('focusout', function() {
        setTimeout(function() {
          window.scrollTo(0, 0);
          // Check if we should trigger recalc
          if (viewport.height >= fullHeight - 50 && wasKeyboardOpen) {
            console.log('[KB-FIX] Focusout detected, forcing Flutter recalc');
            forceFlutterRecalc();
            wasKeyboardOpen = false;
          }
        }, 150);
      });

      console.log('[KB-FIX] Android keyboard fix initialized');
    })();
  </script>

  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
